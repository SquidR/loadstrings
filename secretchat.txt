-- Older-style secret chat GUI using TextChatService + deterministic jumble
local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- CONFIG
local SEED = 2031
local ALPHABET = "abcdefghijklmnopqrstuvwxyz"

-- Build deterministic shuffled alphabet
local rng = Random.new(SEED)
local letters = {}
for i = 1, #ALPHABET do
    letters[i] = ALPHABET:sub(i, i)
end
for i = #letters, 2, -1 do
    local j = rng:NextInteger(1, i)
    letters[i], letters[j] = letters[j], letters[i]
end

-- Build encode / decode maps (preserve case)
local encodeMap, decodeMap = {}, {}
for i = 1, #ALPHABET do
    local p = ALPHABET:sub(i, i)
    local c = letters[i]
    encodeMap[p] = c
    encodeMap[p:upper()] = c:upper()
    decodeMap[c] = p
    decodeMap[c:upper()] = p:upper()
end

local function encode(text)
    return text:gsub(".", function(ch)
        return encodeMap[ch] or ch
    end)
end

local function decode(text)
    return text:gsub(".", function(ch)
        return decodeMap[ch] or ch
    end)
end

-- GUI creation (CoreGui so executors can show it)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SecretChatGui"
screenGui.Parent = game:GetService("CoreGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 420, 0, 360)
frame.Position = UDim2.new(1, -430, 1, -370)
frame.BackgroundColor3 = Color3.fromRGB(23, 23, 23)
frame.BorderSizePixel = 0
frame.Parent = screenGui

-- Titlebar + close button
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 32)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
titleBar.BorderSizePixel = 0
titleBar.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -36, 1, 0)
title.Position = UDim2.new(0, 6, 0, 0)
title.BackgroundTransparency = 1
title.Text = "Secret Chat"
title.TextSize = 18
title.Font = Enum.Font.SourceSansBold
title.TextColor3 = Color3.new(1, 1, 1)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 1, 0)
closeBtn.Position = UDim2.new(1, -34, 0, 0)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 18
closeBtn.BackgroundTransparency = 1
closeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
closeBtn.Parent = titleBar

closeBtn.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- Scrolling message area
local scroll = Instance.new("ScrollingFrame")
scroll.Size = UDim2.new(1, -12, 1, -86)
scroll.Position = UDim2.new(0, 6, 0, 38)
scroll.BackgroundTransparency = 1
scroll.BorderSizePixel = 0
scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
scroll.ScrollBarThickness = 6
scroll.Parent = frame

local uiLayout = Instance.new("UIListLayout")
uiLayout.SortOrder = Enum.SortOrder.LayoutOrder
uiLayout.Padding = UDim.new(0, 4)
uiLayout.Parent = scroll

-- Input box + send button area
local inputBox = Instance.new("TextBox")
inputBox.Size = UDim2.new(1, -86, 0, 30)
inputBox.Position = UDim2.new(0, 6, 1, -40)
inputBox.PlaceholderText = "Type secret message here..."
inputBox.Text = ""
inputBox.ClearTextOnFocus = false
inputBox.TextColor3 = Color3.new(1,1,1)
inputBox.BackgroundColor3 = Color3.fromRGB(36,36,36)
inputBox.BorderSizePixel = 0
inputBox.Font = Enum.Font.SourceSans
inputBox.TextSize = 18
inputBox.Parent = frame

local sendBtn = Instance.new("TextButton")
sendBtn.Size = UDim2.new(0, 70, 0, 30)
sendBtn.Position = UDim2.new(1, -78, 1, -40)
sendBtn.Text = "Send"
sendBtn.Font = Enum.Font.SourceSansBold
sendBtn.TextSize = 18
sendBtn.BackgroundColor3 = Color3.fromRGB(50,50,50)
sendBtn.BorderSizePixel = 0
sendBtn.Parent = frame

-- helper to add a decoded message line
local function addMessage(sender, decodedText)
    local lbl = Instance.new("TextLabel")
    lbl.Size = UDim2.new(1, -8, 0, 20)
    lbl.BackgroundTransparency = 1
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.new(1,1,1)
    lbl.Text = ("%s: %s"):format(sender, decodedText)
    lbl.Parent = scroll

    -- update canvas and auto-scroll
    task.wait() -- let layout calculate
    scroll.CanvasSize = UDim2.new(0, 0, 0, uiLayout.AbsoluteContentSize.Y + 4)
    scroll.CanvasPosition = Vector2.new(0, math.max(0, uiLayout.AbsoluteContentSize.Y - scroll.AbsoluteWindowSize.Y))
end

-- Listen for all incoming chat messages and decode them
local channel = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
if not channel then
    -- if TextChannels hasn't been created yet, wait for it.
    TextChatService.TextChannels.ChildAdded:Wait()
    channel = TextChatService.TextChannels:WaitForChild("RBXGeneral")
end

channel.MessageReceived:Connect(function(message)
    local sender = message.TextSource and message.TextSource.Name or "System"
    local decodedText = decode(message.Text)
    addMessage(sender, decodedText)
end)

-- Send: encode then post to real chat
local function sendEncoded(text)
    local encoded = encode(text)
    -- Post to the real chat channel (everyone sees encoded text in normal chat)
    local success, err = pcall(function()
        channel:SendAsync(encoded)
    end)
    if not success then
        warn("Failed to send encoded message via TextChatService:", err)
    end
    -- NOTE: the incoming MessageReceived handler should pick up your own sent message
    -- and display the decoded text. If for some reason your client does NOT receive it,
    -- uncomment the next line as a fallback to display it immediately:
    -- addMessage(LocalPlayer.Name, text)
end

-- hook send button
sendBtn.MouseButton1Click:Connect(function()
    if inputBox.Text and inputBox.Text ~= "" then
        sendEncoded(inputBox.Text)
        inputBox.Text = ""
    end
end)

-- allow Enter key to send
inputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed and inputBox.Text and inputBox.Text ~= "" then
        sendEncoded(inputBox.Text)
        inputBox.Text = ""
    end
end)
